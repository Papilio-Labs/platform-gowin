; PlatformIO Project Configuration File
;
; Papilio RetroCade - ESP32-S3 + Gowin FPGA Dual-Target Build
; 
; This project supports building both ESP32-S3 firmware and Gowin FPGA gateware
; in a single unified workflow. The FPGA bitstream is automatically built after
; the ESP32 firmware compilation completes.
;
; For more information: https://docs.platformio.org/page/projectconf.html

[platformio]
default_envs = esp32, fpga

; ==============================================================================
; ESP32-S3 Firmware Build
; ==============================================================================
[env:esp32]
platform = espressif32
board = seeed_xiao_esp32s3
framework = arduino
build_type = debug

; ESP32-S3 memory and flash configuration
board_build.arduino.memory_type = qio_qspi
board_build.flash_mode = qio
board_build.psram_type = qio
board_upload.flash_size = 4MB
board_upload.maximum_size = 4194304
board_build.partitions = default.csv
board_build.filesystem = littlefs

; Build flags
build_flags = 
    -I include
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DBOARD_HAS_PSRAM
    -DFPGA_ENABLED=1
    -DESP32_S3=1
    ; SPI pins for FPGA communication (adjust as needed)
    -DFPGA_SPI_CLK=12
    -DFPGA_SPI_MISO=9
    -DFPGA_SPI_MOSI=11
    -DFPGA_SPI_CS=10
    ; Additional FPGA control pins
    -DFPGA_RESET_PIN=26

; Upload configuration
upload_protocol = esptool
upload_speed = 921600

; Serial monitor configuration
monitor_speed = 115200
monitor_filters = 
    esp32_exception_decoder

; Library dependencies
lib_deps = 
    fastled/FastLED@^3.9.4

; ==============================================================================
; FPGA Gateware Build
; ==============================================================================
[env:fpga]
platform = gowin
board = papilio_retrocade_fpga
framework = hdl

; FPGA-specific configuration
board_build.fpga_project = fpga/project.gprj
board_build.gowin_path = C:/Gowin/Gowin_V1.9.11.03_Education_x64

; Upload protocol for FPGA
upload_protocol = pesptool

; ==============================================================================
; Combined Environment (builds both ESP32 and FPGA)
; ==============================================================================
[env:papilio_retrocade]
platform = espressif32
board = seeed_xiao_esp32s3
framework = arduino
build_type = debug

; Custom build script to add FPGA building
extra_scripts = 
    post:scripts/post_build.py

; ESP32-S3 memory and flash configuration
board_build.arduino.memory_type = qio_qspi
board_build.flash_mode = qio
board_build.psram_type = qio
board_upload.flash_size = 4MB
board_upload.maximum_size = 4194304
board_build.partitions = default.csv
board_build.filesystem = littlefs

; Build flags
build_flags = 
    -I include
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DBOARD_HAS_PSRAM
    -DFPGA_ENABLED=1
    -DESP32_S3=1
    ; SPI pins for FPGA communication (adjust as needed)
    -DFPGA_SPI_CLK=12
    -DFPGA_SPI_MISO=9
    -DFPGA_SPI_MOSI=11
    -DFPGA_SPI_CS=10
    ; Additional FPGA control pins
    -DFPGA_RESET_PIN=26
    ; Debug flags (uncomment for verbose output)
    ; -DCORE_DEBUG_LEVEL=5

; FPGA-specific configuration
; Path to Gowin project file (relative to project root)
board_build.fpga_project = fpga/project.gprj

; Gowin toolchain path (REQUIRED for FPGA builds)
; Update this to match your Gowin installation
board_build.gowin_path = C:/Gowin/Gowin_V1.9.11.03_Education_x64

; Upload configuration
upload_protocol = esptool
upload_speed = 921600

; Custom upload command for dual-target (ESP32 + FPGA)
; Comment out to use standard ESP32-only upload
upload_command = 
    python upload_dual.py 
    --esp32-firmware $SOURCE 
    --esp32-port $UPLOAD_PORT 
    --esp32-baud $UPLOAD_SPEED 
    --fpga-bitstream $BUILD_DIR/fpga_bitstream.bin 
    --fpga-protocol pesptool

; FPGA upload protocol options:
; - pesptool: Upload via ESP32-S3 SPI bridge (default, requires pesptool)
; - openfpgaloader: Direct JTAG/USB upload (requires openFPGALoader)
; - gowin: Gowin Programmer (requires Gowin EDA installation)

; Serial monitor configuration
monitor_speed = 115200
monitor_filters = 
    esp32_exception_decoder

; Library dependencies
lib_deps = 
    fastled/FastLED@^3.9.4
    https://github.com/GadgetFactory/papilio_rgb_led.git#0.1.0
    https://github.com/GadgetFactory/papilio_wishbone_spi_master.git#0.1.0
    https://github.com/GadgetFactory/papilio_hdmi.git#main

; ==============================================================================
; ESP32-Only Environment (for testing without FPGA build)
; ==============================================================================
[env:esp32_only]
platform = espressif32
board = seeed_xiao_esp32s3
framework = arduino
build_type = debug

; ESP32-S3 memory and flash configuration
board_build.arduino.memory_type = qio_qspi
board_build.flash_mode = qio
board_build.psram_type = qio
board_upload.flash_size = 4MB
board_upload.maximum_size = 4194304
board_build.partitions = default.csv
board_build.filesystem = littlefs

build_flags = 
    -I include
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DBOARD_HAS_PSRAM
    -DFPGA_ENABLED=0
    -DESP32_S3=1

upload_protocol = esptool
upload_speed = 921600
monitor_speed = 115200
monitor_filters = 
    esp32_exception_decoder

; Library dependencies
lib_deps = 
    fastled/FastLED@^3.9.4
    https://github.com/GadgetFactory/papilio_rgb_led.git#0.1.0
    https://github.com/GadgetFactory/papilio_wishbone_spi_master.git#0.1.0
    https://github.com/GadgetFactory/papilio_hdmi.git#main

; ==============================================================================
; FPGA-Only Environment (for testing FPGA build independently)
; ==============================================================================
[env:fpga_only]
platform = gowin
board = papilio_retrocade_fpga
framework = verilog

; This environment only builds the FPGA gateware
; No ESP32 firmware is built

; FPGA configuration
board_build.fpga_project = fpga/project.gprj
board_build.gowin_path = C:/Gowin/Gowin_V1.9.11.03_Education_x64

; Note: Upload protocol for FPGA-only
upload_protocol = pesptool
